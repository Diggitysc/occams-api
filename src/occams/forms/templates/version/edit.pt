<!DOCTYPE html>
<html metal:use-macro="load: ../master.pt">
  <metal:content-slot fill-slot="content-slot">

    <header class="page-header">
      <h1>${schema.title}</h1>
      <ul metal:use-macro="load: ./panels/details.pt" />
    </header>

    <p class="lead" tal:condition="schema.description">${schema.description}</p>

    <!-- ko ifnot:isReady() -->
      <p class="text-center" i18n:translate="">
        <span class="glyphicon glyphicon-refresh fa-spin"></span>
        <span i18n:translate="">Loading</span>
      </p>
    <!-- /ko -->

    <div id="of-editor"
        style="display: none;"
        data-bind="visible: isReady">

      <div class="row">
        <div id="of-content" class="col-md-9">

          <!-- ko ifnot: hasFields -->
            <div id="of-empty"
                class="text-muted"
                data-bind="fadeVisible: { if: !isDragging(), duration: 'fast' }">
              <h4 i18n:translate="">This form does not have any fields addded yet.</h4>
              <p i18n:translate="">To add new fields, drag an item from the types menu.</p>
            </div>
          <!-- /ko -->

          <div id="of-form-root" data-bind="template: {name: 'field-template', data: $data}"></div>

        </div>

        <!-- Field types -->
        <div id="of-sidebar" class="col-md-3">
          <div id="of-types" class="panel panel-primary">
            <div class="panel-heading">
              <h3 class="panel-title" i18n:translate="">Add new field...</h3>
            </div>
            <!-- ko foreach: types -->
              <div class="list-group"
                  data-bind="
                    draggable: {
                      data: $data,
                      isEnabled: $root.isMovingEnabled,
                      options: {
                        cursor: 'move',
                        helper: newTypeHelper,
                        revert: 'invalid',
                        start: newTypeDragStart,
                        stop: newTypeDragStop
                      }
                    }">
                <a class="list-group-item list-group-item-info of-type"
                  data-bind="
                    attr: {'data-type': name},
                    text: title
                  "></a>
              </div>
            <!-- /ko -->
          </div> <!-- /.panel -->
        </div> <!-- /.col-md-3 -->
      </div> <!-- /.row -->

      <hr width="100%" />

      <div class="pull-right">
        <button class="btn btn-lg btn-primary" i18n:translate="">Done</button>
      </div>

    </div> <!-- /#of-editor" -->

    <script id="field-template" type="text/html">
      <div class="of-fields"
          data-bind="
            sortable: {
              data: fields,
              dragged: $root.startAdd,
              isEnabled: $root.isMovingEnabled,
              beforeMove: $root.doMoveField,
              options: {
                axis: 'y',
                cursor: 'move',
                forcePlaceholderSize: true,
                placeholder: 'of-placeholder',
                revert: true,
              }
            }
          ">
        <div class="of-field">
          <!-- ko ifnot: $root.isSelectedField($data) -->
            <div data-bind="template: {name: 'field-view-template', data: $data}"></div>
          <!-- /ko -->
          <!-- ko if: $root.isSelectedField($data) && $root.showEditView()-->
            <div data-bind="template: {name: 'field-edit-template', data: $data}"></div>
          <!-- /ko -->
          <!-- ko if: $root.isSelectedField($data) && $root.showDeleteView -->
            <div data-bind="template: {name: 'field-delete-template', data: $data}"></div>
          <!-- /ko -->
        </div>
      </div>
    </script>

    <script id="field-view-template" type="text/html">
      <div class="row of-view" data-bind="css: {'of-editable': $root.isMovingEnabled()}">

        <div class="col-md-10">
          <div class="form-group">
            <!-- ko ifnot: isSection -->
              <p>
                <code data-bind="text: name"></code>
                &bull;
                <code data-bind="text: type"></code>
              </p>
              <label data-bind="css: {'required': is_required}, text: title"></label>
            <!-- /ko -->
            <!-- ko if: isSection -->
              <h3 class="page-header" data-bind="text: title"></h3>
            <!-- /ko -->
            <!-- ko if: description -->
              <p class="help-block" data-bind="text: description"></p>
            <!-- /ko -->
            <!-- ko ifnot: isSection -->
              <!-- ko if: type() == 'choice' -->
                <!-- ko foreach: choices -->
                  <div data-bind="css: $parent.choiceInputType">
                    <label>
                      <input disabled data-bind="
                          attr: {
                            name: $parent.name,
                            type: $parent.choiceInputType,
                            value: name
                          }" />
                      <span data-bind="text: title"></span>
                    </label>
                  </div>
                <!-- /ko -->
              <!-- /ko -->
              <!-- ko if: type() == 'date' -->
                <input type="date" class="form-control" disabled />
              <!-- /ko -->
              <!-- ko if: type() == 'datetime' -->
                <input type="date" class="form-control" disabled />
              <!-- /ko -->
              <!-- ko if: type() == 'blob' -->
                <input type="file" class="form-control" disabled />
              <!-- /ko -->
              <!-- ko if: type() == 'number' -->
                <input type="decimal" class="form-control" disabled />
              <!-- /ko -->
              <!-- ko if: type() == 'string' -->
                <input type="text" class="form-control" disabled />
              <!-- /ko -->
              <!-- ko if: type() == 'text' -->
                <textarea class="form-control" disabled></textarea>
              <!-- /ko -->
            <!-- /ko -->
          </div>
        </div> <!-- /.col-md-10 -->

        <div class="col-md-2 text-right">
          <div class="of-controls btn-group">
            <button type="button" class="btn btn-default" data-bind="click: $root.startDelete">
              <span class="glyphicon glyphicon-trash"></span>
            </button>
            <button type="button" class="btn btn-default" data-bind="click: $root.startEdit">
              <span class="glyphicon glyphicon-pencil"></span>
            </button>
          </div>
        </div> <!-- /.col-md-3 -->

      </div> <!-- /.row -->

      <!-- ko if: isSection -->
        <div data-bind="template: {name: 'field-template', data: $data}"></div>
      <!-- /ko -->
    </script>


    <script id="field-edit-template" type="text/html">
      <div class="of-edit">
        <form tal:define="form field_form; wtforms load:../wtforms.pt">

          <metal:field tal:define="field form.name" use-macro="wtforms.field" />
          <metal:field tal:define="field form.title" use-macro="wtforms.field" />
          <metal:field tal:define="field form.description" use-macro="wtforms.field" />

          <metal:field tal:define="field form.type" use-macro="wtforms.field">
            <metal:widget fill-slot="widget">
              <div class="row">
                <div class="col-xs-4">
                  <input metal:use-macro="wtforms.widget" />
                </div>
              </div>
            </metal:widget>
          </metal:field>

          <!-- ko ifnot: isSection -->
            <metal:field tal:define="field form.is_required" use-macro="wtforms.widget" />
            <metal:field tal:define="field form.is_private" use-macro="wtforms.widget" />
            <metal:field tal:define="field form.is_system" use-macro="wtforms.widget" />
            <metal:field tal:define="field form.is_readonly" use-macro="wtforms.widget" />
          <!-- /ko -->

          <!-- ko if: isType('choice') -->
            <metal:field tal:define="field form.is_collection" use-macro="wtforms.widget" />
            <metal:field tal:define="field form.is_shuffled" use-macro="wtforms.widget" />
            <metal:field tal:define="field form.choices" use-macro="wtforms.field">
              <metal:widget fill-slot="widget">
                <div class="row">
                  <div class="col-xs-2"><strong>Code</strong></div>
                  <div class="col-xs-8"><strong>Label</strong></div>
                </div>
                <!-- ko foreach: {data: choices, as: 'choice'} -->
                  <div class="row">
                    <div class="col-xs-2">
                      <input type="text" class="form-control" data-bind="value:choice.name" />
                    </div>
                    <div class="col-xs-8">
                      <input type="text" class="form-control" data-bind="value:choice.title" />
                    </div>
                    <div class="col-xs-2">
                      <div class="btn-group">
                        <button class="btn btn-default"><span class="glyphicon glyphicon-trash"></span></button>
                        <button class="btn btn-default"><span class="glyphicon glyphicon-plus"></span></button>
                      </div>
                    </div>
                  </div>
                <!-- /ko -->
              </metal:widget>
            </metal:field>
          <!-- /ko -->

          <!-- ko if: isType('number', 'string') -->
            <metal:field tal:define="field form.value_limit" use-macro="wtforms.default">
              <div class="row" metal:fill-slot="widget">
                <div class="col-xs-2">
                  ${structure: field['min'](class_='form-control', placeholder='Min')}
                </div>
                <div class="col-xs-2">
                  ${structure: field['max'](class_='form-control', placeholder='Max')}
                </div>
              </div>
            </metal:field>
          <!-- /ko -->
          <!-- ko if: is_collection -->
            <metal:field tal:define="field form.collection_limit" use-macro="wtforms.default">
              <div class="row" metal:fill-slot="widget">
                <div class="col-xs-2">
                  ${structure: field['min'](class_='form-control', placeholder='Min')}
                </div>
                <div class="col-xs-2">
                  ${structure: field['max'](class_='form-control', placeholder='Max')}
                </div>
              </div>
            </metal:field>
          <!-- /ko -->
          <!-- ko if: isType('number') -->
            <metal:field tal:define="field form.decimal_places" use-macro="wtforms.default">
              <div class="row" metal:fill-slot="widget">
                <div class="col-xs-2">
                  ${structure: field(class_='form-control')}
                </div>
              </div>
            </metal:field>
          <!-- /ko -->

          <!-- ko if: isType('string') -->
            <metal:field tal:define="field form.pattern" use-macro="wtforms.field" />
          <!-- /ko -->

          <hr width="100%" />

          <div class="text-right">
            <button type="button" class="btn btn-link" data-bind="click: $root.doCancelEdit">Cancel</button>
            <button type="button" class="btn btn-primary" data-bind="click: $root.doEditField">
              <!-- ko ifnot: isNew -->
                <span i18n:translate="">Save</span>
              <!-- /ko -->
              <!-- ko if: isNew -->
                <span i18n:translate="">Create</span>
              <!-- /ko -->
              <span class="fa fa-refresh fa-spin" style="display: none" data-bind="visible: isSaving"></span>
            </button>
          </div>
        </form>
      </div>
    </script>

    <script id="field-delete-template" type="text/html">
      <div class="of-delete">
        <div class="form-group">
          <label>Are you sure you want to delete <code data-bind="text: name"></code> from this version of the form?</label>
          <p class="help-block">
            <span data-bind="visible: !isSection() && $root.publish_date()">All  data entered for this field will be removed deleted.</span>
            <span data-bind="visible: isSection">Removing this section will also remove all sub-fields.</span>
            <span>This action cannot be reversed.</span>
          </p>
        </div>
        <div class="text-right">
          <button type="button" class="btn btn-link" data-bind="click: $root.clearSelected">Cancel</button>
          <button type="button" class="btn btn-danger" data-bind="click: $root.doDeleteField">Yes, I'm sure</button>
        </div>
      </div>
    </script>

  </metal:content-slot>
</html>

