<!DOCTYPE html>
<html metal:use-macro="load: ../master.pt">
  <metal:content-slot fill-slot="content-slot">

    <header class="page-header">
      <h1>${schema.title}</h1>
      <ul metal:use-macro="load: ./panels/details.pt" />
    </header>

    <p class="lead" tal:condition="schema.description">${schema.description}</p>

    <!-- ko ifnot:isReady() -->
      <p class="text-center" i18n:translate="">
        <span class="glyphicon glyphicon-refresh fa-spin"></span>
        <span i18n:translate="">Loading</span>
      </p>
    <!-- /ko -->

    <div id="of-editor"
        style="display: none;"
        data-bind="visible: isReady">

      <div class="row">
        <div id="of-content" class="col-md-9">

          <!-- ko ifnot: hasFields -->
            <div id="of-empty"
                class="text-muted"
                data-bind="fadeVisible: { if: !isDragging(), duration: 'fast' }">
              <h4 i18n:translate="">This form does not have any fields addded yet.</h4>
              <p i18n:translate="">To add new fields, drag an item from the types menu.</p>
            </div>
          <!-- /ko -->

          <div id="of-form-root" data-bind="template: {name: 'field-template', data: $data}"></div>

        </div>

        <!-- Field types -->
        <div id="of-sidebar" class="col-md-3">
          <div id="of-types" class="panel panel-primary">
            <div class="panel-heading">
              <h3 class="panel-title" i18n:translate="">Add new field...</h3>
            </div>
            <!-- ko foreach: types -->
              <div class="list-group"
                  data-bind="
                    draggable: {
                      data: $data,
                      isEnabled: $root.isMovingEnabled,
                      options: {
                        cursor: 'move',
                        helper: newTypeHelper,
                        revert: 'invalid',
                        start: newTypeDragStart,
                        stop: newTypeDragStop
                      }
                    }">
                <a class="list-group-item list-group-item-info of-type"
                  data-bind="
                    attr: {'data-type': name},
                    text: title
                  "></a>
              </div>
            <!-- /ko -->
          </div> <!-- /.panel -->
        </div> <!-- /.col-md-3 -->
      </div> <!-- /.row -->

      <hr width="100%" />

      <div class="pull-right">
        <button class="btn btn-lg btn-primary" i18n:translate="">Done</button>
      </div>

    </div> <!-- /#of-editor" -->

    <script id="field-template" type="text/html">
      <div class="of-fields"
          data-bind="
            sortable: {
              data: fields,
              dragged: $root.startAdd,
              isEnabled: $root.isMovingEnabled,
              beforeMove: $root.doMoveField,
              options: {
                axis: 'y',
                cursor: 'move',
                forcePlaceholderSize: true,
                placeholder: 'of-placeholder',
                revert: true,
              }
            }
          ">
        <div class="of-field">
          <!-- ko ifnot: $root.isSelectedField($data) -->
            <div data-bind="template: 'field-view-template'"></div>
          <!-- /ko -->
          <!-- ko if: $root.isSelectedField($data) && $root.showEditView()-->
            <div data-bind="template: 'field-edit-template'"></div>
          <!-- /ko -->
          <!-- ko if: $root.isSelectedField($data) && $root.showDeleteView() -->
            <div data-bind="template: 'field-delete-template'"></div>
          <!-- /ko -->
        </div>
      </div>
    </script>

    <script id="field-view-template" type="text/html">
      <div class="row of-view" data-bind="css: {'of-editable': $root.isMovingEnabled()}">

        <div class="col-md-10">
          <div class="form-group">
            <!-- ko ifnot: isSection -->
              <p>
                <code data-bind="text: name"></code>
                &bull;
                <code data-bind="text: type"></code>
              </p>
              <label data-bind="css: {'required': is_required}, text: title"></label>
            <!-- /ko -->
            <!-- ko if: isSection -->
              <h3 class="page-header" data-bind="text: title"></h3>
            <!-- /ko -->
            <!-- ko if: description -->
              <p class="help-block" data-bind="text: description"></p>
            <!-- /ko -->
            <!-- ko ifnot: isSection -->
              <!-- ko if: type() == 'choice' -->
                <!-- ko foreach: choices -->
                  <div data-bind="css: $parent.choiceInputType">
                    <label>
                      <input disabled data-bind="
                          attr: {
                            name: $parent.name,
                            type: $parent.choiceInputType,
                            value: name
                          }" />
                      <span data-bind="text: title"></span>
                    </label>
                  </div>
                <!-- /ko -->
              <!-- /ko -->
              <!-- ko if: type() == 'date' -->
                <input type="date" class="form-control" disabled />
              <!-- /ko -->
              <!-- ko if: type() == 'datetime' -->
                <input type="date" class="form-control" disabled />
              <!-- /ko -->
              <!-- ko if: type() == 'blob' -->
                <input type="file" class="form-control" disabled />
              <!-- /ko -->
              <!-- ko if: type() == 'number' -->
                <input type="decimal" class="form-control" disabled />
              <!-- /ko -->
              <!-- ko if: type() == 'string' -->
                <input type="text" class="form-control" disabled />
              <!-- /ko -->
              <!-- ko if: type() == 'text' -->
                <textarea class="form-control" disabled></textarea>
              <!-- /ko -->
            <!-- /ko -->
          </div>
        </div> <!-- /.col-md-10 -->

        <div class="col-md-2 text-right">
          <div class="of-controls btn-group">
            <button type="button" class="btn btn-default" data-bind="click: $root.startDelete">
              <span class="glyphicon glyphicon-trash"></span>
            </button>
            <button type="button" class="btn btn-default" data-bind="click: $root.startEdit">
              <span class="glyphicon glyphicon-pencil"></span>
            </button>
          </div>
        </div> <!-- /.col-md-3 -->

      </div> <!-- /.row -->

      <!-- ko if: isSection -->
        <div data-bind="template: {name: 'field-template', data: $data}"></div>
      <!-- /ko -->
    </script>


    <script id="field-edit-template" type="text/html">
      <div class="of-edit" data-bind="with: $root.selectedFieldForEditing()"
          tal:define="render_field import:occams.forms.renderers.render_field">
        <form tal:define="form field_form" class="form-horizontal"
            data-bind="validate: makeValidateOptions()">

          <tal:field define="name 'type'; field form[name];">
            <div class="form-group">
              <label class="col-sm-2 control-label" i18n:translate="">Type</label>
              <div class="col-sm-4">
                <!-- ko if: isNew -->
                  <input tal:define="ko string: value: $name, select2: {}"
                         tal:replace="structure: render_field(field,
                                                              class_='form-control',
                                                              data_bind=ko)" />
                <!-- /ko -->
                <!-- ko ifnot: isNew -->
                  <p class="form-control-static"><code data-bind="text:type"></code></p>
                <!-- /ko -->
              </div>
              <div class="col-sm-4">
                <div class="checkbox" data-bind="visible: isType('choice')">
                  <label class="checkbox-inline">
                    <input type="checkbox" data-bind="checked: is_collection, enable: isType('choice') && isNew()" />
                    <span i18n:translate="">Multiple-Choice</span>
                  </label>
                </div>
              </div>
            </div>
          </tal:field>

          <tal:field define="name 'name'; field form[name];">
            <div class="form-group">
              <label class="col-sm-2 control-label" i18n:translate="">Variable</label>
              <div class="col-sm-10">
                <div class="row">
                  <div class="col-sm-6">
                    <!-- ko if: isNew -->
                      <input tal:define="ko string: value: $name, hasFocus: true"
                             tal:replace="structure: render_field(field,
                                                                  class_='form-control',
                                                                  data_bind=ko)" />
                    <!-- /ko -->
                    <!-- ko ifnot: isNew -->
                      <p class="form-control-static"><code data-bind="text: ${name}"></code></p>
                    <!-- /ko -->
                  </div>
                </div>
              </div>
            </div>
          </tal:field>

          <tal:field define="name 'title'; field form[name];">
            <div class="form-group">
              <label class="col-sm-2 control-label" i18n:translate="">Question</label>
              <div class="col-sm-10">
                <input tal:define="ko string: value: $name"
                       tal:replace="structure: render_field(field,
                                                            class_='form-control',
                                                            data_bind=ko)" />
              </div>
            </div>
          </tal:field>

          <tal:field define="name 'description'; field form[name];">
            <div class="form-group">
              <label class="col-sm-2 control-label" i18n:translate="">Help Text</label>
              <div class="col-sm-10">
                <input tal:define="ko string: value: $name"
                       tal:replace="structure: render_field(field,
                                                            class_='form-control',
                                                            rows=5,
                                                            data_bind=ko)" />
              </div>
            </div>
          </tal:field>

          <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
              <div class="row">
                <div class="col-sm-5">
                  <div class="checkbox" data-bind="visible: !isSection()">
                    <label>
                      <input type="checkbox" data-bind="checked: is_required, disable: isSection" />
                      <span i18n:translate="">Required</span>
                    </label>
                  </div>
                  <div class="checkbox" data-bind="visible: !isSection()">
                    <label>
                      <input type="checkbox" data-bind="checked: is_private, disable: isSection" />
                      <span i18n:translate="">Private</span>
                    </label>
                  </div>
                </div>
                <div class="col-sm-5">
                  <div class="checkbox" data-bind="visible: !isSection()">
                    <label>
                      <input type="checkbox" data-bind="checked: is_readonly, disable: isSection" />
                      <span i18n:translate="">Read-only</span>
                    </label>
                  </div>
                  <div class="checkbox" data-bind="visible: !isSection()">
                    <label>
                      <input type="checkbox" data-bind="checked: is_system, disable: isSection" />
                      <span i18n:translate="">Managed by system services</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <tal:field define="name 'decimal_places'; field form[name];">
            <div class="form-group" data-bind="visible: isType('number')">
              <label class="col-sm-2 control-label" i18n:translate="">Decimal Places</label>
              <div class="col-sm-4">
                <input tal:define="ko string: value: $name"
                       tal:replace="structure: render_field(field,
                                                            class_='form-control',
                                                            data_bind=ko)" />
              </div>
            </div>
          </tal:field>

          <div class="form-group" data-bind="visible: isLimitAllowed">
            <label class="col-sm-2 control-label" i18n:translate="">Limits</label>
            <div class="col-sm-3" tal:define="name 'value_min'; field form[name]">
              <input tal:define="ko string: value: $name, enable: isLimitAllowed"
                     tal:replace="structure: render_field(field,
                                                          class_='form-control',
                                                          placeholder='Min',
                                                          data_bind=ko)" />
            </div>
            <div class="col-sm-3" tal:define="name 'value_max'; field form[name]">
              <input tal:define="ko string: value: $name, enable: isLimitAllowed"
                     tal:replace="structure: render_field(field,
                                                          class_='form-control',
                                                          placeholder='Max',
                                                          data_bind=ko)" />
            </div>
          </div>

          <tal:field define="name 'pattern'; field form[name];">
            <div class="form-group" data-bind="visible: isType('string')">
              <label class="col-sm-2 control-label" i18n:translate="">Pattern</label>
              <div class="col-sm-10">
                <input tal:define="ko string: value: $name"
                       tal:replace="structure: render_field(field,
                                                            class_='form-control',
                                                            data_bind=ko)" />
              </div>
            </div>
          </tal:field>

          <div class="form-group" data-bind="visible: isType('choice')">
            <label class="col-sm-2 control-label" i18n:translate="">Choices</label>
            <div class="col-sm-10">
              <div data-bind="sortable: choices">
                <div class="js-draggable row">
                  <!--! Generate the manually because it's difficult to reach
                        subvalues -->
                  <div class="col-sm-3 js-validation-group">
                    <input type="text"
                        class="form-control"
                        required
                        pattern="-?[0-9]+"
                        data-msg-pattern="Must be digits"
                        data-msg-required="Required"
                        maxlength="8"
                        placeholder="Code"
                        data-bind="value: name, uniqueName: true" />
                  </div>
                  <div class="col-sm-7 js-validation-group">
                    <input type="text"
                        class="form-control"
                        placeholder="Label"
                        required
                        data-msg-required="Required"
                        data-bind="value: title, uniqueName: true" />
                  </div>
                  <div class="col-sm-2">
                    <!--! tabindex: Do not tab to this element -->
                    <button class="btn btn-link"
                        tabindex="-1"
                        data-bind="click: $parent.doDeleteChoice">
                      <span class="glyphicon glyphicon-trash"></span>
                    </button>
                  </div>
                </div>
              </div>
              <!--! tabindex: Do not tab to this element -->
              <button class="btn btn-link"
                  tabindex="-1"
                  data-bind="click: doAddChoice">
                <span class="glyphicon glyphicon-plus"></span>
                <span i18n:translate="">Add another</span>
              </button>
            </div>
          </div>

          <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
              <div class="checkbox" data-bind="visible: isType('choice')">
                <label>
                  <input type="checkbox" data-bind="checked: is_shuffled, enable: isType('choice')" />
                  <span i18n:translate="">Shuffle answer choices when entering data.</span>
                </label>
              </div>
            </div>
          </div>

          <div class="text-right">
            <button type="button" class="btn btn-link" data-bind="click: $root.doCancelEdit">Cancel</button>
            <button type="button" class="btn btn-primary" data-bind="click: $root.doEditField">
              <!-- ko ifnot: isNew -->
                <span i18n:translate="">Save</span>
              <!-- /ko -->
              <!-- ko if: isNew -->
                <span i18n:translate="">Create</span>
              <!-- /ko -->
              <span class="fa fa-refresh fa-spin" style="display: none" data-bind="visible: isSaving"></span>
            </button>
          </div>
        </form>
      </div>
    </script>

    <script id="field-delete-template" type="text/html">
      <div class="of-delete">
        <div class="form-group">
          <label>Are you sure you want to delete <code data-bind="text: name"></code> from this version of the form?</label>
          <p class="help-block">
            <span data-bind="visible: !isSection() && $root.publish_date()">All  data entered for this field will be removed deleted.</span>
            <span data-bind="visible: isSection">Removing this section will also remove all sub-fields.</span>
            <span>This action cannot be reversed.</span>
          </p>
        </div>
        <div class="text-right">
          <button type="button" class="btn btn-link" data-bind="click: $root.clearSelected">Cancel</button>
          <button type="button" class="btn btn-danger" data-bind="click: $root.doDeleteField">Yes, I'm sure</button>
        </div>
      </div>
    </script>

  </metal:content-slot>
</html>

