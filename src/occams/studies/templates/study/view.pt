<html i18n:domain="occams.studies" metal:use-macro="load: ../master.pt">
  <metal:content-slot fill-slot="content-slot">
    <div style="display: none;" data-bind="visible: isReady">

      <header class="page-header">
        <div class="btn-toolbar pull-right">
          <input type="checkbox" id="grid-toggle"
            data-bind="bootstrapSwitch: isGridEnabled"
            data-label-text="Grid"
            />
          <a href="#" class="btn btn-default"><span class="fa fa-random"></span> Upload RIDs</a>
          <a href="#" class="btn btn-default"><span class="fa fa-edit"></span> Edit</a>
          <a href="#" class="btn btn-default"><span class="fa fa-trash-o"></span> Delete</a>
        </div>
        <h1 i18n:translate="">${context.title} <small><span class="fa fa-lock" tal:condition="context.is_locked"></span></small></h1>
        <ul metal:use-macro="load: ./panels/details.pt" />
        <nav metal:use-macro="load: ./panels/nav.pt" />
      </header>

      <div id="js-schedule" class="table-responsive table-scrollable">
        <!-- Pre-generated corner -->
        <table id="js-schedule-corner" class="table table-bordered table-striped table-dimensional table-rotated-header">
          <thead>
            <!-- "width: auto" affects cell width, neect to use div -->
            <th i18n:translate=""><div class="form">Visit Forms</div></th>
          </thead>
        </table>
        <!-- Pre-generated header bar -->
        <table id="js-schedule-header" class="table table-bordered table-striped table-dimensional table-rotated-header">
          <thead>
            <tr>
              <!-- "width: auto" affects cell width, neect to use div -->
              <th i18n:translate=""><div class="form">Visit Forms</div></th>
              <!-- ko foreach: study.cycles -->
                <th class="rotated">
                  <span class="rotated-container">
                    <span class="rotated-rotate">
                      <span class="rotated-text">
                        <button class="link js-popover-trigger"
                            data-placement="bottom"
                            data-bind="
                              text: title,
                              click: $root.startViewCycle"></button>
                      </span>
                    </span>
                  </span>
                </th>
              <!-- /ko -->
              <th class="rotated">
                <div class="rotated-container">
                  <div class="rotated-rotate">
                    <span class="rorated-text">
                      <button class="btn btn-link" data-bind="click: startAddCycle">
                        <span class="fa fa-plus"></span>
                        <strong i18n:translate="">Add Cycle</strong>
                      </button>
                    </span>
                  </div>
                </div>
              </th>
            </tr>
          </thead>
        </table>
        <!-- Pre-generated side bar -->
        <table id="js-schedule-sidebar" class="table table-bordered table-striped table-dimensional table-rotated-header">
          <tbody>
            <!-- ko foreach: {data: study.schemata, as: 'schema'} -->
              <tr>
                <th>
                  <div class="form clearfix">
                    <div class="pull-right">
                      <!-- ko if: hasMultipleVersions -->
                        <span class="badge" data-bind="text: versionsLength"></span>
                      <!-- /ko -->
                    </div>
                    <button class="link" data-bind="text: title"></button>
                  </div>
                </th>
              </tr>
            <!-- /ko -->
            <tr>
              <th>
                <button class="btn btn-link">
                  <span class="fa fa-plus"></span>
                  <strong i18n:translate="">Add Form</strong>
                </button>
              </th>
            </tr>
          </tbody>
        </table>
        <!-- Main data table -->
        <table id="js-schedule-table" class="table table-bordered table-striped table-dimensional table-rotated-header">
          <thead>
            <tr>
              <!-- "width: auto" affects cell width, neect to use div -->
              <th i18n:translate=""><div class="form">Visit Forms</div></th>
              <!-- ko foreach: study.cycles -->
                <th class="rotated js-popover">
                  <span class="rotated-container">
                    <span class="rotated-rotate">
                      <span class="rotated-text">
                        <button class="link js-popover-trigger"
                            data-placement="bottom"
                            data-bind="
                              text: title,
                              click: $root.startViewCycle"></button>
                      </span>
                    </span>
                  </span>
                </th>
              <!-- /ko -->
              <th class="rotated">
                <div class="rotated-container">
                  <div class="rotated-rotate">
                    <span class="rorated-text">
                      <button class="btn btn-link" data-bind="click: startAddCycle">
                        <span class="fa fa-plus"></span>
                        <strong i18n:translate="">Add Cycle</strong>
                      </button>
                    </span>
                  </div>
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <!-- ko foreach: {data: study.schemata, as: 'schema'} -->
              <tr>
                <th>
                  <div class="form clearfix">
                    <div class="pull-right">
                      <!-- ko if: hasMultipleVersions -->
                        <span class="badge" data-bind="text: versionsLength"></span>
                      <!-- /ko -->
                    </div>
                    <button class="link" data-bind="text: title"></button>
                  </div>
                </th>
                <!-- ko foreach: {data: $root.study.cycles, as: 'cycle'} -->
                  <td data-bind="event: {dblclick: $root.toggleGrid}">
                    <!-- ko if: cycle.containsSchema(schema.name) -->
                      <span class="fa fa-check"></span>
                    <!-- /ko -->
                  </td>
                <!-- /ko -->
              </tr>
            <!-- /ko -->
            <tr>
              <th>
                <button class="btn btn-link">
                  <span class="fa fa-plus"></span>
                  <strong i18n:translate="">Add Form</strong>
                </button>
              </th>
            </tr>
          </tbody>
        </table>
      </div> <!-- /#js-schedule -->
    </div> <!-- /:isReady -->

    <div class="modal fade" data-bind="showModal: selectedCycle, with: selectedCycle">
      <div class="modal-dialog">
        <div class="modal-content">
          <!-- ko if: $root.showViewCycle -->
            <form class="form-horizontal">
              <div class="modal-header">
                <div class="btn-toolbar pull-right">
                  <div class="btn-group">
                    <button class="btn btn-default" data-bind="click: $root.startEditCycle"><span class="fa fa-edit"></span></button>
                    <button class="btn btn-default" data-bind="click: $root.startDeleteCycle"><span class="fa fa-trash-o"></span></button>
                  </div>
                </div>
                <h4 class="modal-title" data-bind="text: title"></h4>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label class="col-sm-2 control-label required">Title</label>
                  <div class="col-sm-10">
                    <p class="form-control-static" data-bind="text: title"></p>
                  </div>
                </div> <!-- /.form-group -->
                <div class="form-group">
                  <label class="col-sm-2 control-label required">Code</label>
                  <div class="col-sm-10">
                    <p class="form-control-static"><code data-bind="text: name"></code></p>
                  </div>
                </div> <!-- /.form-group -->
                <div class="form-group">
                  <label class="col-sm-2 control-label">Week</label>
                  <div class="col-sm-10">
                    <!-- ko if: week -->
                      <p class="form-control-static"><code data-bind="text: week"></code></p>
                    <!-- /ko -->
                  </div>
                </div> <!-- /.form-group -->
                <div class="form-group">
                  <div class="col-sm-offset-2 col-sm-10">
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" disabled data-bind="checked: is_interim" />
                        <span i18n:translate="">Off-schedule</span>
                      </label>
                    </div>
                  </div>
                </div> <!-- /.form-group -->
              </div> <!-- /.modal-body -->
              <div class="modal-footer">
                <button type="button"
                    class="btn btn-link"
                    data-bind="click: $root.clear"
                    i18n:translate="">Close</button>
              </div>
            </form>
          <!-- /ko -->
          <!-- ko if: $root.showEditCycle -->
            <form class="form-horizontal"
                data-factory-url="${request.current_route_path('cycles')}"
                data-bind="
                  validate: window.defaultValidationOptions,
                  submit: $root.saveCycle">
              <div class="modal-header">
                <!-- ko if: id -->
                  <h4 class="modal-title" data-bind="text: title"></h4>
                <!-- /ko -->
                <!-- ko ifnot: id -->
                  <h4 class="modal-title">New Cycle</h4>
                <!-- /ko -->
              </div>
              <div class="modal-body" data-bind="with: $root.editableCycle">
                <div data-bind="template: {name: 'validation-errors-template', if: $root.hasErrorMessages, data: $root.errorMessages}"></div>
                <div class="form-group">
                  <label class="col-sm-2 control-label required">Title</label>
                  <div class="col-sm-10">
                    <input type="text" class="form-control" required name="title" data-bind="value: title"/>
                  </div>
                </div> <!-- /.form-group -->
                <div class="form-group">
                  <label class="col-sm-2 control-label required">Code</label>
                  <div class="col-sm-10">
                    <input type="text" class="form-control" required name="name" data-bind="value: name"/>
                  </div>
                </div> <!-- /.form-group -->
                <div class="form-group">
                  <label class="col-sm-2 control-label">Week</label>
                  <div class="col-sm-10">
                    <input type="number" step="1" class="form-control" name="week" data-bind="value: week"/>
                  </div>
                </div> <!-- /.form-group -->
                <div class="form-group">
                  <div class="col-sm-offset-2 col-sm-10">
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" name="is_interim" data-bind="checked: is_interim" />
                        <span i18n:translate="">Off-schedule</span>
                      </label>
                    </div>
                  </div>
                </div> <!-- /.form-group -->
              </div> <!-- /.modal-body -->
              <div class="modal-footer">
                <!-- ko ifnot: id -->
                  <label class="text-muted">
                    <input type="checkbox" name="add_more" />
                    <span i18n:translate="">Add another</span>
                  </label>
                <!-- /ko -->
                <!-- ko if: id -->
                  <button
                      type="button"
                      class="btn btn-link"
                      data-bind="click: $root.startViewCycle"
                      i18n:translate="">Cancel</button>
                <!-- /ko -->
                <!-- ko ifnot: id -->
                  <button
                      type="button"
                      class="btn btn-link"
                      data-bind="click: $root.clear"
                      i18n:translate="">Cancel</button>
                <!-- /ko -->
                <button type="submit" class="btn btn-primary">
                  <span i18n:translate="">Save</span>
                  <!-- ko if: $root.isSaving -->
                    <span class="fa fa-refresh fa-spin"></span>
                  <!-- /ko -->
                </button>
              </div>
            </form>
          <!-- /ko -->
          <!-- ko if: $root.showDeleteCycle -->
            <form class="form-horizontal" data-bind="submit: $root.deleteCycle">
              <div class="modal-header">
                <h4 class="modal-title" i18n:translate="">Delete Cycle</h4>
              </div>
              <div class="modal-body">
                <p>
                  <span i18n:translate="">You are about to delete</span>
                  <strong data-bind="text: title"></strong>.
                  <span i18n:translate="">Are you sure you want to continue?</span>
                </p>
              </div> <!-- /.modal-body -->
              <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-link"
                    data-bind="click: $root.startViewCycle"
                    i18n:translate="">No</button>
                <button type="submit" class="btn btn-danger">
                  <span i18n:translate="">Yes</span>
                  <!-- ko if: $root.isSaving -->
                    <span class="fa fa-refresh fa-spin"></span>
                  <!-- /ko -->
                </button>
              </div>
            </form>
          <!-- /ko -->
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <script id="validation-errors-template" type="text/html">
      <div class="alert alert-danger" role="alert">
        <strong>Error!</strong> <span>Could not complete request for the following reasons:</span>
        <ul data-bind="foreach: $data">
          <li data-bind="text: $data"></li>
        </ul>
      </div>
    </script>

    <tal:json define="json import:json">
      <script id="study-data" type="application/json">${json.dumps(study)}</script>
    </tal:json>

  </metal:content-slot>
</html>
