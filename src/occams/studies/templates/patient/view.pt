<html i18n:domain="occams.studies" metal:use-macro="load: ../master.pt">
  <metal:content-slot fill-slot="content-slot" tal:define="json import:json">

    <div id="views-patient-main">

      <div style="display: none;" data-bind="visible: isReady">

        <header class="page-header">
          <div class="btn-toolbar pull-right">
            <button class="btn btn-default"
                data-bind="click: $root.startEdit"
                tal:condition="request.has_permission('edit')">
              <span class="fa fa-edit"></span>
              <span i18n:translate="">Edit</span>
            </button>
            <button class="btn btn-default"
                data-bind="click: $root.startDelete"
                tal:condition="request.has_permission('delete')">
              <span class="fa fa-trash-o"></span>
              <span i18n:translate="">Delete</span>
            </button>
          </div>
          <h1 i18n:translate="" data-bind="text: patient.pid"></h1>
          <ul class="details list-inline">
            <li data-bind="with: patient.site">
              <span class="text-muted" i18n:translate="">Site:</span>
              <span data-bind="text: title"></span>
            </li>
          </ul>
          <nav>
            <ul class="nav nav-header" tal:define="current request.current_route_path()">
              <li tal:define="url request.route_path('studies')">
                <a href="${url}">
                  <span class="fa fa-chevron-left"></span>
                </a>
              </li>
              <li tal:define="url request.current_route_path(_route_name='patient')"
                  class="${'active' if current == url else ''}">
                <a href="${url}" i18n:translate="">Overview</a>
              </li>
              <li tal:define="url request.current_route_path(_route_name='patient_forms')"
                  class="${'active' if current == url else ''}">
                <a href="${url}" i18n:translate="">Forms</a>
              </li>
            </ul>
          </nav>
        </header>

         <div class="row">
          <div class="col-sm-4">
            <div class="panel panel-default" data-bind="with: patient">
              <div class="panel-heading clearfix">
                <div class="btn-toolbar pull-right">
                  <button class="btn btn-link btn-xs"
                      data-bind="click: $root.startEdit"
                      tal:condition="request.has_permission('edit')">
                    <span class="fa fa-list"></span>
                    <span i18n:translate="">Manage</span>
                  </button>
                </div>
                <h4 class="panel-title" i18n:translate="">External IDs</h4>
              </div>
              <!-- ko if: references().length <= 0 -->
                <div class="panel-body">
                  <p class="text-muted text-center" i18n:translate="">No references</p>
                </div>
              <!-- /ko -->
              <!-- ko if: references().length > 0 -->
                <table class="table table-striped">
                  <colgroup>
                    <col class="col-sm-8" />
                    <col class="col-sm-4" />
                  </colgroup>
                  <tbody data-bind="foreach: references">
                    <tr>
                      <!-- ko with: reference_type -->
                        <td data-bind="text: title"></td>
                      <!-- /ko -->
                      <td><code data-bind="text: reference_number"></code></td>
                    </tr>
                  </tbody>
                </table>
              <!-- /ko -->
            </div> <!-- /.panel -->
          </div> <!-- /.col-sm-4 -->
          <div class="col-sm-8">
            <div class="panel panel-default"
                tal:condition="request.has_permission('view', context['enrollments'])">
              <div class="panel-heading clearfix">
                <div class="btn-toolbar pull-right">
                  <button class="btn btn-link btn-xs"
                      data-bind="click: $root.startAddEnrollment"
                      tal:condition="request.has_permission('add', context['enrollments'])">
                    <span class="fa fa-plus"></span>
                    <span i18n:translate="">Add Enrollment</span>
                  </button>
                </div>
                <h4 class="panel-title" i18n:translate="">Enrollments</h4>
              </div>
              <!-- ko ifnot: hasEnrollments -->
                <div class="panel-body">
                  <p class="text-muted text-center" i18n:translate="">No enrollments</p>
                </div>
              <!-- /ko -->
              <!-- ko if: hasEnrollments -->
                <table class="table table-hover table-striped">
                  <colgroup>
                    <col class="col-sm-4" />
                    <col class="col-sm-2" />
                    <col class="col-sm-2" />
                    <col class="col-sm-1" />
                    <col class="col-sm-2" />
                    <col class="col-sm-1" />
                  </colgroup>
                  <thead>
                    <tr>
                      <th i18n:translate="">Study</th>
                      <th i18n:translate="">Consent</th>
                      <th i18n:translate="">Reference #</th>
                      <th i18n:translate="">RANDID</th>
                      <th i18n:translate="">Arm</th>
                      <th />
                    </tr>
                  </thead>
                  <tbody data-bind="foreach: enrollments">
                    <tr>
                      <!-- ko with: study -->
                        <td class="study" data-bind="text: title"></td>
                      <!-- /ko -->
                      <td><code data-bind="text: consent_date"></code></td>
                      <td data-bind="if: reference_number">
                        <code data-bind="text: reference_number"></code>
                      </td>
                      <td data-bind="with: stratum">
                        <code data-bind="text: reference_number"></code>
                      </td>
                      <td>
                        <!-- ko if: study.is_randomized -->
                          <!-- ko if: study.is_blinded -->
                            <em i18n:translate="">Blinded</em>
                          <!-- /ko -->
                          <!-- ko ifnot: study.is_blinded -->
                            <span data-bind="text: stratum.arm.title"></span>
                          <!-- /ko -->
                        <!-- /ko -->
                      </td>
                      <td class="text-right">
                        <div class="dropdown pull-right">
                          <button class="btn btn-link dropdown-toggle" type="button" data-toggle="dropdown">
                            <span class="fa fa-cog"></span><span class="caret"></span>
                          </button>
                          <ul class="dropdown-menu" role="menu">
                            <!-- ko if: __can_edit__ -->
                              <li role="presentation"><a role="menuitem" tabindex="-1" data-bind="click: $root.startEditEnrollment">Edit</a></li>
                            <!-- /ko -->
                            <!-- ko if: __can_terminate__ -->
                              <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Termination</a></li>
                            <!-- /ko -->
                            <!-- ko if: study.is_randomized -->
                              <!-- ko if: study.stratum -->
                                <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Randomization Status</a></li>
                              <!-- /ko -->
                              <!-- ko ifnot: study.stratum -->
                                <!-- ko if: __can_randomize__ -->
                                  <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Randomize</a></li>
                                <!-- /ko -->
                              <!-- /ko -->
                            <!-- /ko -->
                            <!-- ko if: __can_delete__ -->
                              <li role="presentation" class="divider"></li>
                              <li role="presentation"><a role="menuitem" tabindex="-1" href="#" data-bind="click: $root.startDeleteEnrollment">Delete</a></li>
                            <!-- /ko -->
                          </ul>
                        </div>
                      </td>
                     </tr>
                  </tbody>
                </table>
              <!-- /ko -->
            </div> <!-- /.panel -->
          </div> <!-- /.col-sm-8 -->
        </div> <!-- /.row -->

        <div id="visits" class="panel panel-default"
            tal:condition="request.has_permission('view', context['visits'])">
          <div class="panel-heading clearfix">
            <div class="btn-toolbar pull-right">
              <button class="btn btn-link btn-xs"
                  data-bind="click: $root.startAddVisit"
                  tal:condition="request.has_permission('add', context['visits'])">
                <span class="fa fa-plus"></span>
                <span i18n:translate="">Add Visit</span>
              </button>
            </div>
            <h4 class="panel-title" i18n:translate="">Visits</h4>
          </div>
          <!-- ko ifnot: hasVisits -->
            <div class="panel-body">
              <p class="text-muted text-center" i18n:translate="">No visits</p>
            </div>
          <!-- /ko -->
          <!-- ko if: hasVisits -->
            <table class="table table-hover table-striped">
              <colgroup>
                <col class="col-sm-2" />
                <col class="col-sm-4" />
                <col class="col-sm-5" />
                <col class="col-sm-1" />
              </colgroup>
              <thead>
                <tr>
                  <th i18n:translate="">Visit Date</th>
                  <th i18n:translate="">Cycles</th>
                  <th i18n:translate="">Progress</th>
                  <th />
                </tr>
              </thead>
              <tbody data-bind="foreach: visits">
                <tr>
                  <td><code data-bind="text: visit_date"></code></td>
                  <td data-bind="foreach: cycles">
                    <div data-bind="text: title"></div>
                  </td>
                  <td>
                    <div class="progress">
                      <!-- ko if: hasEntities -->
                        <div class="progress-bar progress-bar-success"
                            data-bind="style: {width: entitiesCompletedProgress() + '%'}">
                          <span data-bind="text: entitiesCompletedCount"></span>
                        </div>
                        <div class="progress-bar progress-bar-warning"
                            data-bind="style: {width: entitiesIncompleteProgress() + '%'}">
                          <span data-bind="text: entitiesIncompleteCount"></span>
                        </div>
                        <div class="progress-bar progress-bar-danger"
                            data-bind="style: {width: entitiesNotStartedProgress() + '%'}">
                          <span data-bind="text: entitiesNotStartedCount"></span>
                        </div>
                      <!-- /ko -->
                      <!-- ko ifnot: hasEntities -->
                        <div class="progress-bar progress-bar-warning" style="width: 100%"></div>
                      <!-- /ko -->
                    </div>
                  </td>
                  <td class="text-right">
                    <a class="btn btn-link"
                        data-bind="attr: {href: __url__}">
                      <span class="fa fa-chevron-right"></span>
                    </a>
                  </td>
                </tr>
              </tbody>
            </table>
          <!-- /ko -->
        </div> <!-- /.panel -->

      </div> <!-- /:isReady -->

      <div class="modal fade" data-bind="showModal: $root.showEditForm, if: $root.showEditForm">
        <div class="modal-dialog">
          <div class="modal-content">
            <form
                role="form"
                action="${request.current_route_path(_route_name='patient')}"
                data-bind="with: $root.editableItem,
                           submit: $root.savePatient,
                           validate: window.defaultValidationOptions">
              <div class="modal-header">
                <h4 class="modal-title" i18n:translate="">Edit Patient</h4>
              </div>
              <div class="modal-body">
                <!-- ko if: $root.hasErrorMessages -->
                  <div class="alert alert-danger">
                    <p i18n:translate="">
                      Could not complete the request for the following reasons:
                    </p>
                    <ul data-bind="foreach: $root.errorMessages">
                      <li data-bind="text: $data"></li>
                    </ul>
                  </div>
                <!-- /ko -->
                <div class="form-group">
                  <label i18n:translate="" class="required">Site</label>
                  <p class="help-block" i18n:translate="">
                      Choose a site that the patient belongs to.
                      You may only select a site of which you are a member of.
                  </p>
                  <select
                      class="form-control"
                      required
                      data-bind="value: site, uniqueName:true, select2: {}">
                    <option value="" i18n:translate="">Select a site...</option>
                    <option tal:repeat="site available_sites" value="${site.id}">${site.title}</option>
                  </select>
                </div> <!-- /.form-group -->
                <div class="form-group">
                  <label i18n:translate="">Reference Numbers</label>
                  <!-- ko foreach: references -->
                    <div class="form-group row">
                      <div class="col-sm-5 js-validation-item" tal:define="name 'reference_type'">
                        <select
                          class="form-control ${name}"
                          required
                          data-bind="
                              value: ${name},
                              event: {change: $root.onChangeReferenceType},
                              uniqueName: true,
                              select2: {}
                              ">
                            <option value="" i18n:translate="">Select a reference type...</option>
                            <option tal:repeat="type available_reference_types"
                                tal:attributes="
                                  data-reference_pattern python:type.reference_pattern or None;
                                  data-reference_hint python:type.reference_hint or None;"
                                value="${type.id}">${type.title}</option>
                          </select>
                      </div>
                      <div class="col-sm-5 js-validation-item" tal:define="name 'reference_number'">
                        <input type="text"
                            class="form-control ${name}"
                            required
                            data-bind="
                              value: ${name},
                              uniqueName: true
                              " />
                      </div>
                      <div class="col-sm-2">
                        <button class="btn btn-link" data-bind="click: $root.deleteReference"><span class="fa fa-trash-o"></span></button>
                      </div>
                    </div> <!-- /.row -->
                  <!-- /ko -->
                  <div>
                    <button class="btn btn-link" data-bind="click: $root.addReference">
                      <span class="fa fa-plus"></span>
                      <!-- ko if: references().length > 0 -->
                        <span i18n:translate="">Add another reference number</span>
                      <!-- /ko -->
                      <!-- ko if: references().length <= 0 -->
                        <span i18n:translate="">Add a reference number</span>
                      <!-- /ko -->
                    </button>
                  </div>
                </div> <!-- /.form-group -->
              </div> <!-- /.modal-body -->
              <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-link"
                    data-bind="click: $root.clear"
                    i18n:translate="">Cancel</button>
                <button type="submit" class="btn btn-primary">
                  <span i18n:translate="">Save</span>
                  <!-- ko if: $root.isSaving -->
                    <span class="fa fa-refresh fa-spin"></span>
                  <!-- /ko -->
                </button>
              </div>
            </form>
          </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
      </div><!-- /.modal -->

      <div class="modal fade" data-bind="showModal: $root.showEnrollmentForm, if: $root.showEnrollmentForm">
        <div class="modal-dialog">
          <div class="modal-content">
            <form
                role="form"
                data-factory-url="${request.current_route_path(_route_name='enrollments')}"
                data-bind="with: $root.editableItem,
                           submit: $root.saveEnrollment,
                           validate: window.defaultValidationOptions">
              <div class="modal-header">

                <!-- ko if: id -->
                  <h4 class="modal-title" i18n:translate="">Edit Enrollment</h4>
                <!--/ko -->
                <!-- ko ifnot: id -->
                  <h4 class="modal-title" i18n:translate="">Add Enrollment</h4>
                <!-- /ko -->
              </div>
              <div class="modal-body">
                <!-- ko if: $root.hasErrorMessages -->
                  <div class="alert alert-danger">
                    <p i18n:translate="">
                      Could not complete the request for the following reasons:
                    </p>
                    <ul data-bind="foreach: $root.errorMessages">
                      <li data-bind="text: $data"></li>
                    </ul>
                  </div>
                <!-- /ko -->
                <div class="form-group" tal:define="name 'study'">
                  <label i18n:translate="" for="${name}" class="required">Study</label>
                  <select
                      class="form-control"
                      required
                      title="Please select a study"
                      id="${name}"
                      data-placeholder="Select a study..."
                      i18n:attributes="title data-placeholder"
                      data-bind="
                        disable: id,
                        event: {change: $root.onChangeStudy},
                        value: ${name}, select2: {}">
                    <option></option> <!-- for placeholder -->
                    <option tal:repeat="study available_studies"
                        tal:attributes="
                          data-reference_pattern python:study.reference_pattern or None;
                          data-reference_hint python:study.reference_hint or None;"
                        value="${study.id}">${study.title}</option>
                  </select>
                </div> <!-- /.form-group -->
                <div class="form-group" tal:define="name 'consent_date'">
                  <label i18n:translate="" for="${name}" class="required">Original Consent Date</label>
                  <input type="date"
                      class="form-control"
                      required
                      id="${name}"
                      data-type-hint="date"
                      placeholder="YYYY-MM-DD"
                      data-date-format="YYYY-MM-DD"
                      data-rule-dateISO
                      data-bind="
                        value: ${name},
                        datetimePicker: {pickTime: false, useCurrent: false},
                        uniqueName: true" />
                </div> <!-- /.form-group -->
                <div class="form-group" tal:define="name 'latest_consent_date'">
                  <label i18n:translate="" for="${name}" class="required">Current Consent Date</label>
                  <input type="date"
                      class="form-control"
                      required
                      id="${name}"
                      placeholder="YYYY-MM-DD"
                      data-type-hint="date"
                      data-date-format="YYYY-MM-DD"
                      data-rule-dateISO
                      data-rule-greaterThanEqualTo="#consent_date"
                      data-msg-greaterThanEqualTo="Must be after consent date"
                      data-bind="
                        value: ${name},
                        datetimePicker: {pickTime: false, useCurrent: false},
                        uniqueName: true" />
                </div> <!-- /.form-group -->

                <!--! Termination date is not edited manually, it is filled
                      in by the studie's termination form -->

                <div class="form-group" tal:define="name 'reference_number'">
                  <label i18n:translate="" for="${name}">Reference Number</label>
                  <p class="help-block" i18n:translate="">
                    (Optional) The patient's study-specific identification number.
                  </p>
                  <input type="text"
                      class="form-control"
                      id="${name}"
                      data-bind="value: ${name}, uniqueName:true" />
                </div> <!-- /.form-group -->
              </div> <!-- /.modal-body -->
              <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-link"
                    data-bind="click: $root.clear"
                    i18n:translate="">Cancel</button>
                <button type="submit" class="btn btn-primary">
                  <span i18n:translate="">Save</span>
                  <!-- ko if: $root.isSaving -->
                    <span class="fa fa-refresh fa-spin"></span>
                  <!-- /ko -->
                </button>
              </div>
            </form>
          </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
      </div><!-- /.modal -->

      <div class="modal fade" data-bind="showModal: $root.showEnrollmentDelete, if: $root.showEnrollmentDelete">
        <div class="modal-dialog">
          <div class="modal-content" data-bind="with: $root.selectedItem">
            <form data-bind="submit: $root.deleteEnrollment">
              <div class="modal-header">
                <h4 class="modal-title" i18n:translate="">Confirm Delete</h4>
              </div>
              <div class="modal-body">
                <!-- ko if: $root.hasErrorMessages -->
                  <div class="alert alert-danger">
                    <p i18n:translate="">
                      Could not complete the request for the following reasons:
                    </p>
                    <ul data-bind="foreach: $root.errorMessages">
                      <li data-bind="text: $data"></li>
                    </ul>
                  </div>
                <!-- /ko -->
                <p i18n:translate="">You are about to delete the following enrollment. This is an irreversable action. Are you sure you want to proceed?</p>
                <dl class="dl-horizontal">
                  <dt>Study<dt><dd><span data-bind="text: study.title"></span></dd>
                  <dt>Consent<dt><dd><code data-bind="text: consent_date"></code></dd>
                  <!-- ko if: reference_number -->
                    <dt>Reference #<dt><dd><code data-bind="text: reference_number"></code></dd>
                  <!-- /ko -->
                </dl>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-bind="click: $root.clear" i18n:translate="">Cancel</button>
                <button type="submit" class="btn btn-danger">
                  <span i18n:translate="">Delete</span>
                  <!-- ko if: $root.isSaving -->
                    <span class="fa fa-refresh fa-spin"></span>
                  <!-- /ko -->
                </button>
              </div>
            </form>
          </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
      </div><!-- /.modal -->


      <div class="modal fade" data-bind="showModal: $root.showVisitForm, if: $root.showVisitForm">
        <div class="modal-dialog">
          <div class="modal-content">
            <form
                role="form"
                action="${request.current_route_path(_route_name='visits')}"
                data-bind="with: $root.editableItem,
                           submit: $root.saveVisit,
                           validate: window.defaultValidationOptions">
              <div class="modal-header">
                <!-- ko if: id -->
                  <h4 class="modal-title" i18n:translate="">Edit Visit</h4>
                <!--/ko -->
                <!-- ko ifnot: id -->
                  <h4 class="modal-title" i18n:translate="">Add Visit</h4>
                <!-- /ko -->
              </div>
              <div class="modal-body">
                <!-- ko if: $root.hasErrorMessages -->
                  <div class="alert alert-danger">
                    <p i18n:translate="">
                      Could not complete the request for the following reasons:
                    </p>
                    <ul data-bind="foreach: $root.errorMessages">
                      <li data-bind="text: $data"></li>
                    </ul>
                  </div>
                <!-- /ko -->
                <div class="form-group" tal:define="name 'cycles'">
                  <label i18n:translate="" for="${name}" class="required">Study Cycles</label>
                  <!--! Select2 uses "hidden" for multi-selects -->
                  <input
                      class="form-control"
                      required
                      type="text"
                      title="Please select associated study cycles"
                      id="${name}"
                      name="${name}"
                      data-placeholder="Select a cycle..."
                      data-cycles-url="${request.route_path('visits_cycles', patient=context.pid)}"
                      data-rule-remote="${request.route_path('visits', patient=context.pid)}"
                      i18n:attributes="title data-placeholder"
                      data-bind="
                        selectedValues: ${name},
                        select2: $root.visitSelect2Options($element)" />
                </div> <!-- /.form-group -->
                <div class="form-group" tal:define="name 'visit_date'">
                  <label i18n:translate="" for="${name}" class="required">Visit Date</label>
                  <input type="date"
                      class="form-control"
                      required
                      id="${name}"
                      data-type-hint="date"
                      placeholder="YYYY-MM-DD"
                      data-date-format="YYYY-MM-DD"
                      data-rule-dateISO
                      data-bind="
                        value: ${name},
                        datetimePicker: {pickTime: false, useCurrent: false},
                        uniqueName: true" />
                </div> <!-- /.form-group -->
              </div> <!-- /.modal-body -->
              <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-link"
                    data-bind="click: $root.clear"
                    i18n:translate="">Cancel</button>
                <button type="submit" class="btn btn-primary">
                  <span i18n:translate="">Save</span>
                  <!-- ko if: $root.isSaving -->
                    <span class="fa fa-refresh fa-spin"></span>
                  <!-- /ko -->
                </button>
              </div>
            </form>
          </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
      </div><!-- /.modal -->


      <div class="modal fade" data-bind="showModal: $root.showDeleteForm, if: $root.showDeleteForm">
        <div class="modal-dialog">
          <div class="modal-content">
            <form data-bind="submit: $root.deletePatient">
              <div class="modal-header">
                <h4 class="modal-title" i18n:translate="">Confirm Delete</h4>
              </div>
              <div class="modal-body">
                <!-- ko if: $root.hasErrorMessages -->
                  <div class="alert alert-danger">
                    <p i18n:translate="">
                      Could not complete the request for the following reasons:
                    </p>
                    <ul data-bind="foreach: $root.errorMessages">
                      <li data-bind="text: $data"></li>
                    </ul>
                  </div>
                <!-- /ko -->
                <p i18n:translate="">You are about to delete this patient. This is an irreversable action. Are you sure you want to proceed?</p>
              </div> <!-- /.modal-body -->
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-bind="click: $root.clear">Cancel</button>
                <button type="button" class="btn btn-danger" i18n:translate="">Delete</button>
              </div>
            </form>
          </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
      </div><!-- /.modal -->

    </div> <!-- /#views-patient-main -->

    <script id="patient-data" type="application/json">${json.dumps(patient)}</script>
    <script id="enrollments-data" type="application/json">${json.dumps(enrollments)}</script>
    <script id="visits-data" type="application/json">${json.dumps(visits)}</script>

  </metal:content-slot>
  <metal:content-slot fill-slot="javascript-extras-slot">
    <script>
      $(function(){
        ko.applyBindings(new PatientView, document.getElementById('views-patient-main'));
      });
    </script>
  </metal:content-slot>
</html>

