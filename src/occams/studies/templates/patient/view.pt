<html i18n:domain="occams.studies" metal:use-macro="load: ../master.pt">
  <metal:content-slot fill-slot="content-slot" tal:define="json import:json">

    <script id="patient-data" type="application/json">${json.dumps(patient)}</script>

    <div style="display: none;" data-bind="visible: isReady">

      <header class="page-header">
        <div class="btn-toolbar pull-right">
          <button class="btn btn-default"
              data-bind="click: $root.startEdit"
              tal:condition="request.has_permission('patient_edit')">
            <span class="fa fa-edit"></span>
            <span i18n:translate="">Edit</span>
          </button>
          <button class="btn btn-default"
              data-bind="click: $root.startDelete"
              tal:condition="request.has_permission('patient_delete')">
            <span class="fa fa-trash-o"></span>
            <span i18n:translate="">Delete</span>
          </button>
        </div>
        <h1 i18n:translate="" data-bind="text: patient.pid"></h1>
        <ul class="details list-inline">
          <li data-bind="with: patient.site">
            <span class="text-muted" i18n:translate="">Site:</span>
            <span data-bind="text: title"></span>
          </li>
        </ul>
        <nav>
          <ul class="nav nav-header">
            <li><a href="${request.route_path('studies')}" i18n:translate=""><span class="fa fa-chevron-left"></a></li>
            <li><a href="${request.current_route_path(_route_name='patient')}" i18n:translate="">Overview</a></li>
            <li><a href="${request.current_route_path(_route_name='patient_forms')}" i18n:translate="">Forms</a></li>
          </ul>
        </nav>
      </header>

       <div class="row">
        <div class="col-sm-4">
          <div class="panel panel-default" data-bind="with: patient">
            <div class="panel-heading clearfix">
              <div class="btn-toolbar pull-right">
                <button class="btn btn-link btn-xs"
                    data-bind="click: $root.startEdit"
                    tal:condition="request.has_permission('patient_edit')">
                  <span class="fa fa-list"></span>
                  <span i18n:translate="">Manage</span>
                </button>
              </div>
              <h4 class="panel-title" i18n:translate="">External IDs</h4>
            </div>
            <!-- ko if: references().length <= 0 -->
              <div class="panel-body">
                <p class="text-muted text-center" i18n:translate="">No references</p>
              </div>
            <!-- /ko -->
            <!-- ko if: references().length > 0 -->
              <table class="table table-striped">
                <colgroup>
                  <col class="col-sm-8" />
                  <col class="col-sm-4" />
                </colgroup>
                <tbody data-bind="foreach: references">
                  <tr>
                    <!-- ko with: reference_type -->
                      <td data-bind="text: title"></td>
                    <!-- /ko -->
                    <td><code data-bind="text: reference_number"></code></td>
                  </tr>
                </tbody>
              </table>
            <!-- /ko -->
          </div> <!-- /.panel -->
        </div> <!-- /.col-sm-4 -->
        <div class="col-sm-8">
          <div class="panel panel-default" tal:condition="request.has_permission('enrollment_view')">
            <script id="enrollments-data" type="application/json">${json.dumps(enrollments)}</script>
            <div class="panel-heading clearfix">
              <div class="btn-toolbar pull-right">
                <button class="btn btn-link btn-xs"
                    data-bind="click: $root.startAddEnrollment"
                    tal:condition="request.has_permission('enrollment_add')">
                  <span class="fa fa-plus"></span>
                  <span i18n:translate="">Add Enrollment</span>
                </button>
              </div>
              <h4 class="panel-title" i18n:translate="">Enrollments</h4>
            </div>
            <!-- ko ifnot: hasEnrollments -->
              <div class="panel-body">
                <p class="text-muted text-center" i18n:translate="">No enrollments</p>
              </div>
            <!-- /ko -->
            <!-- ko if: hasEnrollments -->
              <table class="table table-hover table-striped">
                <colgroup>
                  <col class="col-sm-4" />
                  <col class="col-sm-2" />
                  <col class="col-sm-2" />
                  <col class="col-sm-1" />
                  <col class="col-sm-2" />
                  <col class="col-sm-1" />
                </colgroup>
                <thead>
                  <tr>
                    <th i18n:translate="">Study</th>
                    <th i18n:translate="">Consent</th>
                    <th i18n:translate="">Reference #</th>
                    <th i18n:translate="">RANDID</th>
                    <th i18n:translate="">Arm</th>
                    <th />
                  </tr>
                </thead>
                <tbody data-bind="foreach: enrollments">
                  <tr>
                    <!-- ko with: study -->
                      <td class="study" data-bind="text: title"></td>
                    <!-- /ko -->
                    <td data-bind="dateText: consent_date"></td>
                    <td data-bind="if: reference_number">
                      <code data-bind="text: reference_number"></code>
                    </td>
                    <td data-bind="with: stratum">
                      <code data-bind="text: reference_number"></code>
                    </td>
                    <td data-bind="if: false">
                      <!-- ko if: study().is_blinded() -->
                        <em i18n:translate="">Blinded</em>
                      <!-- /ko -->
                      <!-- ko ifnot: study().is_blinded() -->
                        <span data-bind="text: stratum().arm().title()"></span>
                      <!-- /ko -->
                    </td>
                    <td class="text-right">
                      <a href="" class="btn btn-link"><span class="fa fa-chevron-right"></span></a>
                    </td>
                   </tr>
                </tbody>
              </table>
            <!-- /ko -->
          </div> <!-- /.panel -->
        </div> <!-- /.col-sm-8 -->
      </div> <!-- /.row -->

      <div id="visits" class="panel panel-default" tal:condition="request.has_permission('visit_view')">
        <script id="visits-data" type="application/json">${json.dumps(visits)}</script>
        <div class="panel-heading clearfix">
          <div class="btn-toolbar pull-right">
            <button class="btn btn-link btn-xs"
                data-bind="click: $root.startAddVisit"
                tal:condition="request.has_permission('visit_add')">
              <span class="fa fa-plus"></span>
              <span i18n:translate="">Add Visit</span>
            </button>
          </div>
          <h4 class="panel-title" i18n:translate="">Visits</h4>
        </div>
        <!-- ko ifnot: hasVisits -->
          <div class="panel-body">
            <p class="text-muted text-center" i18n:translate="">No visits</p>
          </div>
        <!-- /ko -->
        <!-- ko if: hasVisits -->
          <table class="table table-hover table-striped">
            <colgroup>
              <col class="col-sm-2" />
              <col class="col-sm-4" />
              <col class="col-sm-5" />
              <col class="col-sm-1" />
            </colgroup>
            <thead>
              <tr>
                <th i18n:translate="">Visit Date</th>
                <th i18n:translate="">Cycles</th>
                <th i18n:translate="">Progress</th>
                <th />
              </tr>
            </thead>
            <tbody data-bind="foreach: visits">
              <tr>
                <td data-bind="dateText: visit_date"></td>
                <td data-bind="foreach: cycles">
                  <div data-bind="text: title"></div>
                </td>
                <td>
                  <div class="progress">
                    <div class="progress-bar"
                        role="progressbar"
                        aria-valuenow="0"
                        aria-valuemin="0"
                        aria-valuemax="100"
                        data-bind="
                          attr: {'aria-valuenow': $root.visitProgress($data)},
                          style: {width: $root.visitProgress($data) + '%'}">
                      <span data-bind="text: forms_complete"></span>
                      /
                      <span data-bind="text: forms_total"></span>
                    </div>
                  </div>
                </td>
                <td class="text-right"><a class="btn btn-link"><span class="fa fa-chevron-right"></span></a></td>
              </tr>
            </tbody>
          </table>
        <!-- /ko -->
      </div> <!-- /.panel -->

    </div> <!-- /:isReady -->

    <div class="modal fade" data-bind="showModal: $root.showEditForm, if: $root.showEditForm">
      <div class="modal-dialog">
        <div class="modal-content">
          <form
              role="form"
              action="${request.current_route_path(_route_name='patient')}"
              data-bind="with: $root.editableItem,
                         submit: $root.savePatient,
                         validate: window.defaultValidationOptions">
            <div class="modal-header">
              <h4 class="modal-title" i18n:translate="">Edit Patient</h4>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label i18n:translate="" class="required">Site</label>
                <p class="help-block" i18n:translate="">
                    Choose a site that the patient belongs to.
                    You may only select a site of which you are a member of.
                </p>
                <select
                    class="form-control"
                    required
                    data-bind="value: site_id, uniqueName:true, select2: {}">
                  <option value="" i18n:translate="">Select a site...</option>
                  <option tal:repeat="site available_sites" value="${site.id}">${site.title}</option>
                </select>
              </div> <!-- /.form-group -->
              <div class="form-group">
                <label i18n:translate="">Reference Numbers</label>
                <!-- ko foreach: references -->
                  <div class="form-group row">
                    <div class="col-sm-5 js-validation-item" tal:define="name 'reference_type_id'">
                      <select
                        class="form-control ${name}"
                        required
                        data-bind="
                            value: ${name},
                            event: {change: $root.onChangeReferenceType},
                            uniqueName: true,
                            select2: {}
                            ">
                          <option value="" i18n:translate="">Select a reference type...</option>
                          <option tal:repeat="type available_reference_types"
                              tal:attributes="
                                data-reference_pattern python:type.reference_pattern or None;
                                data-reference_hint python:type.reference_hint or None;"
                              value="${type.id}">${type.title}</option>
                        </select>
                    </div>
                    <div class="col-sm-5 js-validation-item" tal:define="name 'reference_number'">
                      <input type="text"
                          class="form-control ${name}"
                          required
                          data-bind="
                            value: ${name},
                            uniqueName: true
                            " />
                    </div>
                    <div class="col-sm-2">
                      <button class="btn btn-link" data-bind="click: $root.deleteReference"><span class="fa fa-trash-o"></span></button>
                    </div>
                  </div> <!-- /.row -->
                <!-- /ko -->
                <div>
                  <button class="btn btn-link" data-bind="click: $root.addReference">
                    <span class="fa fa-plus"></span>
                    <!-- ko if: references().length > 0 -->
                      <span i18n:translate="">Add another reference number</span>
                    <!-- /ko -->
                    <!-- ko if: references().length <= 0 -->
                      <span i18n:translate="">Add a reference number</span>
                    <!-- /ko -->
                  </button>
                </div>
              </div> <!-- /.form-group -->
            </div> <!-- /.modal-body -->
            <div class="modal-footer">
              <button
                  type="button"
                  class="btn btn-link"
                  data-bind="click: $root.clear"
                  i18n:translate="">Close</button>
              <button type="submit" class="btn btn-primary">
                <span i18n:translate="">Save</span>
                <!-- ko if: $root.isSaving -->
                  <span class="fa fa-refresh fa-spin"></span>
                <!-- /ko -->
              </button>
            </div>
          </form>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade" data-bind="showModal: $root.showEnrollmentForm, if: $root.showEnrollmentForm">
      <div class="modal-dialog">
        <div class="modal-content">
          <form
              role="form"
              action="${request.current_route_path(_route_name='patient_enrollments')}"
              data-bind="with: $root.editableItem,
                         submit: $root.saveEnrollment,
                         validate: window.defaultValidationOptions">
            <div class="modal-header">
              <!-- ko if: id -->
                <h4 class="modal-title" i18n:translate="">Edit Enrollment</h4>
              <!--/ko -->
              <!-- ko ifnot: id -->
                <h4 class="modal-title" i18n:translate="">Add Enrollment</h4>
              <!-- /ko -->
            </div>
            <div class="modal-body">
              <div class="form-group" tal:define="name 'study_id'">
                <label i18n:translate="" for="${name}" class="required">Study</label>
                <select
                    class="form-control"
                    required
                    title="Please select a study"
                    id="${name}"
                    data-placeholder="Select a study..."
                    i18n:attributes="title data-placeholder"
                    data-bind="
                      disable: id,
                      event: {change: $root.onChangeStudy},
                      value: ${name}, select2: {}">
                  <option></option> <!-- for placeholder -->
                  <option tal:repeat="study available_studies"
                      tal:attributes="
                        data-reference_pattern python:study.reference_pattern or None;
                        data-reference_hint python:study.reference_hint or None;"
                      value="${study.id}">${study.title}</option>
                </select>
              </div> <!-- /.form-group -->
              <div class="form-group" tal:define="name 'consent_date'">
                <label i18n:translate="" for="${name}" class="required">Original Consent Date</label>
                <input type="date"
                    class="form-control"
                    required
                    id="${name}"
                    data-type-hint="date"
                    placeholder="YYYY-MM-DD"
                    data-date-format="YYYY-MM-DD"
                    data-rule-dateISO
                    data-bind="
                      value: ${name},
                      datetimePicker: {pickTime: false, useCurrent: false},
                      uniqueName: true" />
              </div> <!-- /.form-group -->
              <div class="form-group" tal:define="name 'latest_consent_date'">
                <label i18n:translate="" for="${name}" class="required">Current Consent Date</label>
                <input type="date"
                    class="form-control"
                    required
                    id="${name}"
                    placeholder="YYYY-MM-DD"
                    data-type-hint="date"
                    data-date-format="YYYY-MM-DD"
                    data-rule-dateISO
                    data-rule-greaterThanEqualTo="#consent_date"
                    data-msg-greaterThanEqualTo="Must be after consent date"
                    data-bind="
                      value: ${name},
                      datetimePicker: {pickTime: false, useCurrent: false},
                      uniqueName: true" />
              </div> <!-- /.form-group -->

              <!--! Termination date is not edited manually, it is filled
                    in by the studie's termination form -->

              <div class="form-group" tal:define="name 'reference_number'">
                <label i18n:translate="" for="${name}">Reference Number</label>
                <p class="help-block" i18n:translate="">
                  (Optional) The patient's study-specific identification number.
                </p>
                <input type="text"
                    class="form-control"
                    id="${name}"
                    data-bind="value: ${name}, uniqueName:true" />
              </div> <!-- /.form-group -->
            </div> <!-- /.modal-body -->
            <div class="modal-footer">
              <button
                  type="button"
                  class="btn btn-link"
                  data-bind="click: $root.clear"
                  i18n:translate="">Close</button>
              <button type="submit" class="btn btn-primary">
                <span i18n:translate="">Save</span>
                <!-- ko if: $root.isSaving -->
                  <span class="fa fa-refresh fa-spin"></span>
                <!-- /ko -->
              </button>
            </div>
          </form>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade" data-bind="showModal: $root.showVisitForm, if: $root.showVisitForm">
      <div class="modal-dialog">
        <div class="modal-content">
          <form
              role="form"
              action="${request.current_route_path(_route_name='patient_visits')}"
              data-bind="with: $root.editableVisit,
                         submit: $root.saveVisit,
                         validate: window.defaultValidationOptions">
            <div class="modal-header">
              <!-- ko if: id -->
                <h4 class="modal-title" i18n:translate="">Edit Visit</h4>
              <!--/ko -->
              <!-- ko ifnot: id -->
                <h4 class="modal-title" i18n:translate="">Add Visit</h4>
              <!-- /ko -->
            </div>
            <div class="modal-body">
              <div class="form-group" tal:define="name 'cycle_ids'">
                <label i18n:translate="" for="${name}" class="required">Study Cycles</label>
                <select
                    class="form-control"
                    required
                    multiple
                    min="1"
                    title="Please select associated study cycles"
                    id="${name}"
                    data-placeholder="Select a cycle..."
                    i18n:attributes="title data-placeholder"
                    data-bind="
                      disable: id,
                      value: ${name}, select2: {}">
                  <option></option> <!-- for placeholder -->
                </select>
              </div> <!-- /.form-group -->
              <div class="form-group" tal:define="name 'visit_date'">
                <label i18n:translate="" for="${name}" class="required">Visit Date</label>
                <input type="date"
                    class="form-control"
                    required
                    id="${name}"
                    data-type-hint="date"
                    placeholder="YYYY-MM-DD"
                    data-date-format="YYYY-MM-DD"
                    data-rule-dateISO
                    data-bind="
                      value: ${name},
                      datetimePicker: {pickTime: false, useCurrent: false},
                      uniqueName: true" />
              </div> <!-- /.form-group -->
            <div class="modal-footer">
              <button
                  type="button"
                  class="btn btn-link"
                  data-bind="click: $root.clear"
                  i18n:translate="">Close</button>
              <button type="submit" class="btn btn-primary">
                <span i18n:translate="">Save</span>
                <!-- ko if: $root.isSaving -->
                  <span class="fa fa-refresh fa-spin"></span>
                <!-- /ko -->
              </button>
            </div>
          </form>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->


    <div class="modal fade" data-bind="showModal: $root.showDeleteForm, if: $root.showDeleteForm">
      <div class="modal-dialog">
        <div class="modal-content">
          <form data-bind="submit: $root.deletePatient">
            <div class="modal-header">
              <h4 class="modal-title" i18n:translate="">Confirm Delete</h4>
            </div>
            <div class="modal-body">
              <p i18n:translate="">You are about to delete this patient. This is an irreversable action. Are you sure you want to proceed?</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-bind="click: $root.clear">Close</button>
              <button type="button" class="btn btn-danger" i18n:translate="">Delete</button>
            </div>
          </form>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
  </metal:content-slot>
</html>

